services:
  # Simple OHTTP Gateway that decrypts and handles requests
  echo-gateway:
    build:
      context: .
      dockerfile: cmd/echo-gateway/Dockerfile
    image: alpetest/echo-gateway:local
    container_name: echo-gateway
    environment:
      KEY_CONFIG_FILE: /keys/keyconfig-ohttp.yaml
      PRIVATE_KEY_FILE: /keys/ohttp-gateway.key
      GATEWAY_PORT: "8888"
    command: []
    volumes:
      - ./dev/testkeys:/keys:ro
    ports:
      - "8888:8888"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    networks:
      - ohttpnet

  # External Processing gRPC server used by Envoy to relay opaque OHTTP blobs
  ohttp-relay:
    build:
      context: .
      dockerfile: cmd/ohttp-relay/Dockerfile
    image: alpetest/ohttp-relay:local
    container_name: ohttp-relay
    command:
      - "--grpc-port=9006"
      - "--grpc-health-port=9007"
      - "--metrics-port=9090"
      - "--timeout=9s"
      - "--gateway-urls=localhost:http://echo-gateway:8888,envoy:http://echo-gateway:8888,envoy:7777=http://echo-gateway:8888,localhost:7777=http://echo-gateway:8888"
      - "--redis-enable=true"
      - "--redis-addr=redis:6379"
      - "--redis-password="
      - "--redis-db=0"
      - "--v=5"
    ports:
      - "9006:9006" # gRPC (TLS)
      - "9007:9007" # gRPC health
      - "9090:9090" # metrics
    depends_on:
      - echo-gateway
      - redis
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    networks:
      - ohttpnet

  # Simple registry to store and expose the gateway URL in Redis

  # Envoy Proxy configured to call the ext_proc server (ohttp-relay)
  envoy:
    image: envoyproxy/envoy:v1.36-latest
    container_name: envoy
    volumes:
      - ./dev/envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
    command: [ "envoy", "-c", "/etc/envoy/envoy.yaml" ]
    ports:
      - "7777:7777" # Public HTTP port for OHTTP clients (matches test-client default RELAY_URL)
      - "9901:9901" # Envoy admin
    depends_on:
      - ohttp-relay
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - ohttpnet

  redis:
    image: redis:8.2.3-alpine
    container_name: redis
    ports:
      - "6379:6379"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /data
    networks:
      - ohttpnet
    # Simple OHTTP client for manual testing
    # Disabled by default; enable via:
    # docker compose --profile client up test-client-rly
  test-client-rly:
    image: golang:1.25
    container_name: ohttprelay-test-client
    working_dir: /app
    environment:
      KEY_CONFIG_FILE: /keys/keyconfig-ohttp.yaml
      RELAY_URL: http://envoy:7777
    volumes:
      - ./:/app:ro
      - ./dev/testkeys:/keys:ro
    command: [ "go", "run", "./cmd/test-client" ]
    depends_on:
      - envoy
    networks:
      - ohttpnet
    profiles: [ "client" ]

networks:
  ohttpnet:
    name: ohttpnet
    driver: bridge
