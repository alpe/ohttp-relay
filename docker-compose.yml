services:
  # Simple OHTTP Gateway that decrypts and handles requests
  echo-gateway:
    build:
      context: .
      dockerfile: cmd/echo-gateway/Dockerfile
    image: alpetest/echo-gateway:local
    container_name: echo-gateway
    environment:
      KEY_CONFIG_FILE: /keys/keyconfig-ohttp.yaml
      PRIVATE_KEY_FILE: /keys/ohttp-gateway.key
      GATEWAY_PORT: "8888"
    command: [ ]
    volumes:
      - ./dev/testkeys:/keys:ro
    ports:
      - "8888:8888"
    networks:
      - ohttpnet

  # External Processing gRPC server used by Envoy to relay opaque OHTTP blobs
  ohttprelay:
    build:
      context: .
      dockerfile: cmd/ohttprelay/Dockerfile
    image: alpetest/ohttprelay:local
    container_name: ohttprelay
    command:
      - "--grpc-port=9006"
      - "--grpc-health-port=9007"
      - "--metrics-port=9090"
      - "--timeout=9s"
      - "--default-gateway-url=http://echo-gateway:8888"
      - "--redis-enable=true"
      - "--redis-addr=redis:6379"
      - "--redis-password="
      - "--redis-db=0"
      - "--v=5"
    ports:
      - "9006:9006"   # gRPC (TLS)
      - "9007:9007"   # gRPC health
      - "9090:9090"   # metrics
    depends_on:
      - echo-gateway
      - redis
    networks:
      - ohttpnet

  # Simple registry to store and expose the gateway URL in Redis
  gateway-registry:
    build:
      context: .
      dockerfile: cmd/gateway-registry/Dockerfile
    image: alpetest/gateway-registry:local
    container_name: gateway-registry
    command:
      - "--default-gateway-url=http://echo-gateway:8888"
      - "--redis-addr=redis:6379"
      - "--redis-password="
      - "--redis-db=0"
      - "--listen=:8080"
    ports:
      - "8080:8080"   # HTTP API for setting/getting the gateway URL
    depends_on:
      - redis
    networks:
      - ohttpnet

  # Envoy Proxy configured to call the ext_proc server (ohttprelay)
  envoy:
    image: envoyproxy/envoy:v1.36-latest
    container_name: envoy
    volumes:
      - ./dev/envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
    command: [ "envoy", "-c", "/etc/envoy/envoy.yaml" ]
    ports:
      - "7777:7777"   # Public HTTP port for OHTTP clients (matches test-client default RELAY_URL)
      - "9901:9901"   # Envoy admin
    depends_on:
      - ohttprelay
    networks:
      - ohttpnet

  redis:
    image: redis:8.2.3-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - ohttpnet

    # Simple OHTTP client for manual testing
    # Disabled by default; enable via:
    # docker compose --profile client up test-client-rly
  test-client-rly:
    image: golang:1.25
    container_name: ohttprelay-test-client
    working_dir: /app
    environment:
      KEY_CONFIG_FILE: /keys/keyconfig-ohttp.yaml
      RELAY_URL: http://envoy:7777
    volumes:
      - ./:/app:ro
      - ./dev/testkeys:/keys:ro
    command: [ "go", "run", "./cmd/test-client" ]
    depends_on:
      - envoy
    networks:
      - ohttpnet
    profiles: [ "client" ]

networks:
  ohttpnet:
    name: ohttpnet
    driver: bridge
